name: Daily Auto-Commit Trigger

on:
  schedule:
    # Runs at 6 AM UTC every day (11:30 AM IST)
    # Cron format: minute hour day-of-month month day-of-week
    - cron: '0 6 * * *'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  trigger-auto-commit:
    runs-on: ubuntu-latest
    
    steps:
      - name: Trigger Auto-Commit Endpoint
        env:
          APP_URL: ${{ secrets.APP_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          echo "ðŸš€ Triggering auto-commit at $(date -u)"
          
          # Retry up to 3 times with increasing delays
          max_attempts=3
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "ðŸ“¡ Attempt $attempt of $max_attempts..."
            
            response=$(curl -s -w "\n%{http_code}" \
              --connect-timeout 30 \
              --max-time 120 \
              -X GET "${APP_URL}/api/cron/daily" \
              -H "Authorization: Bearer ${CRON_SECRET}" \
              -H "Content-Type: application/json" \
              -H "User-Agent: CommitHabit-GitHubActions/1.0" \
              -H "Accept: application/json")
          
            # Extract HTTP status code (last line)
            http_code=$(echo "$response" | tail -n1)
            # Extract response body (all but last line)
            body=$(echo "$response" | sed '$d')
          
            echo "ðŸ“‹ Response Status: $http_code"
            echo "ðŸ“‹ Response Body: $body"
          
            # Check if request was successful
            if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
              echo "âœ… Auto-commit trigger successful!"
              exit 0
            fi
            
            # If middleware failed, wait and retry
            if echo "$body" | grep -q "MIDDLEWARE_INVOCATION_FAILED"; then
              echo "âš ï¸ Middleware error, retrying in $((attempt * 10)) seconds..."
              sleep $((attempt * 10))
              attempt=$((attempt + 1))
            else
              # Other error, don't retry
              echo "âŒ Auto-commit trigger failed with status $http_code"
              exit 1
            fi
          done
          
          echo "âŒ All retry attempts failed"
          exit 1
      
      - name: Summary
        if: always()
        run: |
          echo "## Daily Auto-Commit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered at:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- **Endpoint:** \`/api/cron/daily\`" >> $GITHUB_STEP_SUMMARY
